name: ReSukiSU New
on:
  workflow_dispatch:
    inputs:
      FILE:
        type: choice
        description: "Configuration file"
        required: true
        default: oneplus_13_b
        options:
          - oneplus_10r_v
          - oneplus_nord_3_v
          - oneplus_ace_v
          - oneplus_ace_race_v
          - oneplus_10_pro_v
          - oneplus_10t_v
          - oneplus_11r_b
          - oneplus_ace2_b
          - oneplus_pad_lite_v
          - oneplus_pad_mt6983_v
          - oneplus_ace_2v_v
          - oneplus_ace_pro_v
          - oneplus_11_b
          - oneplus_12r_b
          - oneplus_ace2_pro_b
          - oneplus_ace3_b
          - oneplus_open_b
          - oneplus_nord_ce4_b
          - oneplus_12_b
          - oneplus_pad_go_2_b
          - oneplus_nord_ce4_lite_5g_v
          - oneplus_nord_4_b
          - oneplus_ace_3v_b
          - oneplus_pad_mt6897_v
          - oneplus_13r_b
          - oneplus_ace3_pro_b
          - oneplus_ace5_b
          - oneplus_pad_pro_b
          - oneplus_pad2_b
          - oneplus_nord_ce5_b
          - oneplus_nord_5_b
          - oneplus_ace5_pro_b
          - oneplus_13_b
          - oneplus_13t_b
          - oneplus_13s_b
          - oneplus_pad_2_pro_b
          - oneplus_pad_3_b
          - oneplus_ace5_race_b
          - oneplus_ace5_ultra_b
          - oneplus_pad2_mt6991_b
          - oneplus_ace_6
          - oneplus_ace_6t
          - oneplus_15r
          - oneplus_15
      MANAGER_SOURCE:
        type: choice
        description: "Manager calling direction"
        required: true
        default: NEW
        options:
          - OFFICIAL
          - SPOOF
          - NEW
          - NEW-SPOOF
      SUSFS_CI:
        type: choice
        description: "SUSFS module download call direction"
        required: true
        default: NoN
        options:
          - CI
          - Release
          - NoN
      KPM:
        type: choice
        description: "Kernel module implementation"
        required: true
        default: KPM
        options:
          - KPM
          - KPN
          - NoN
      SUSFS_META:
        type: string
        description: "Rollback SUSFS to a specified hash version"
        required: false
        default: ""
      DYNAMIC_REPO:
        type: string
        description: "Dynamic inventory warehouse owner"
        required: true
        default: "kingmikhail"
      BUILD_TIME:
        type: string
        description: Custom build time (Enter F to use current UTC time)"
        required: false
        default: "Sat Jan 31 11:11:11 UTC 2026"
      KSU_META:
        type: string
        description: "Branch name (required) / Custom version identifier (leave blank and do not modify) / Revert branch commit hash version (leave blank and do not modify)"
        required: false
        default: "builtin/KingMikhail/"
      SUFFIX:
        type: string
        description: "Custom kernel suffix (use random string if not specified)"
        required: false
        default: "KingMikhail-Xclusive"
      SUBLEVEL:
        description: "Custom kernel level spoofing(SUBLEVEL)"
        required: false
        default: ""
      FAST_BUILD:
        type: boolean
        description: "Enable rapid build?"
        required: true
        default: true
      LSM:
        type: boolean
        description: "Should the critical partition write protection module (BBG) be enabled?"
        required: true
        default: true
      NETFILTER:
        type: boolean
        description: "Should we enable Network Function Extensions (NETFILTER)?"
        required: true
        default: true
      BBR_ECN:
        type: boolean
        description: "Should we enable the network optimization algorithm (BBR+ECN)?"
        required: true
        default: true
      UNICODE_BYPASS:
        type: boolean
        description: "Should we add a fix for the Unicode invisible code point bypass read vulnerability?"
        required: true
        default: true
      SCHED:
        type: boolean
        description: "Should we add Windspeed Driver 1.0?"
        required: true
        default: true
      ZRAM:
        type: boolean
        description: "Should we add more ZRAM algorithms?"
        required: true
        default: true
      XUS_FIX:
        type: boolean
        description: "Should we prevent the generation of 5US error files?"
        required: true
        default: true
      SUSFS_DEV:
        type: boolean
        description: "Should we pull the SUSFS-DEV branch?"
        required: true
        default: true
      SPACE_NOCLEAN:
        type: boolean
        description: "Should we disable space cleaning?"
        required: true
        default: false
      BUILD_NOCCACHE:
        type: boolean
        description: "Should we disable Ccache?"
        required: true
        default: false

jobs:
  build:
    name: Build ReSukiSU
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        if: ${{ github.event.inputs.SPACE_NOCLEAN == 'false' }}
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Extract Manifest Info
        id: extract_info
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"
          if [[ "$FILE" =~ ^(.+)_([a-zA-Z])$ ]]; then
            FILE_CONF="${BASH_REMATCH[1]}"
          else
            FILE_CONF="$FILE"
          fi
          FILE_BASE=$(echo "$FILE_CONF" | sed -E 's/_([a-zA-Z0-9])/\U\1/g; s/^oneplus/OnePlus/; s/^realme/Realme/; s/^oppo/Oppo/')
          mkdir -p ".repo/manifests_fallback"
          XML_PATH=".repo/manifests_fallback/${FILE}.xml"
          README_PATH=".repo/manifests_fallback/README.md"
          echo "Deal with FILE=$FILE, CONF=$FILE_CONF, BASE=$FILE_BASE"
          echo "FILE_CONF=$FILE_CONF" >> $GITHUB_ENV
          echo "FILE_BASE=$FILE_BASE" >> $GITHUB_ENV

          # Dynamically calling source code manifest repository, repository priorityÔºö1Ô∏è‚É£ KingMikhail-OnePlusOSS ‚Üí 2Ô∏è‚É£ KingMikhail(Replaceable)
          DYNAMIC_REPO_INPUT="${{ github.event.inputs.DYNAMIC_REPO }}"
          declare -A REPOS
          REPOS["kingmikhail"]="https://api.github.com/repos/kingmikhail/kernel_manifest"
          REPOS["Dynamic"]="https://api.github.com/repos/${DYNAMIC_REPO_INPUT}/kernel_manifest"

          FOUND_REPO=""
          FOUND_BRANCH=""

          check_repo() {
            local OWNER=$1
            local REPO_URL=$2

            echo "üåê Try to pull the ${OWNER} branch list..."
            BRANCHES=$(curl -fsL ${REPO_URL}/branches | jq -r 'if type=="array" then .[].name else empty end' 2>/dev/null || true)
            if [[ -z "$BRANCHES" ]]; then
              echo "‚ö†Ô∏è Failed to retrieve the ${OWNER} branch list. Please try rerunning the workflow"
              return 1
            fi
            for BRANCH in $BRANCHES; do
              XML_URL="https://raw.githubusercontent.com/${OWNER}/kernel_manifest/$BRANCH/${FILE}.xml"
              README_URL="https://raw.githubusercontent.com/${OWNER}/kernel_manifest/$BRANCH/README.md"
              if curl -sf --head "$XML_URL" > /dev/null; then
                echo "‚úÖ Locate ${FILE}.xml within ${OWNER} (branch: $BRANCH)"
                curl -s -o "$XML_PATH" "$XML_URL"
                curl -s -o "$README_PATH" "$README_URL" || true
                FOUND_REPO="$OWNER"
                FOUND_BRANCH="$BRANCH"
                return 0
              fi
            done
            return 1
          }

          # Default repository for file search
          if check_repo "kingmikhail" "${REPOS["kingmikhail"]}"; then
            echo "MANIFEST_REPO=kingmikhail" >> $GITHUB_ENV
            echo "MANIFEST_BRANCH=$FOUND_BRANCH" >> $GITHUB_ENV
          fi

          # Dynamic repository file search
          if [[ -z "$FOUND_REPO" ]]; then
            DYNAMIC_URL="${REPOS["Dynamic"]}"
            DYNAMIC_OWNER=$(echo "$DYNAMIC_URL" | sed -E 's#https://api.github.com/repos/([^/]+)/.*#\1#')
            if check_repo "$DYNAMIC_OWNER" "$DYNAMIC_URL"; then
              echo "MANIFEST_REPO=$DYNAMIC_OWNER" >> $GITHUB_ENV
              echo "MANIFEST_BRANCH=$FOUND_BRANCH" >> $GITHUB_ENV
            fi
          fi

          if [[ -z "$FOUND_REPO" || ! -s "$XML_PATH" ]]; then
            echo "‚ùå Unable to find ${FILE}.xml in the dynamic repository"
            exit 1
          fi

          # Parse the revision string
          REVISION=$(grep -oP '<project[^>]+revision="\K[^"]+' "$XML_PATH" | head -n1 || true)
          echo "Parse the file to obtain CPU and Android version..."
          # Extract CPU
          CPU=$(echo "$REVISION" | sed -E 's#^(oneplus|realme|oppo)/([^_]+).*#\2#')
          # Extract Android version
          ANDROID_VERSION=$(echo "$REVISION" | grep -oP '\d{1,2}\.\d{1,2}(\.\d{1,2})?')
          if [[ -n "$CPU" && -n "$ANDROID_VERSION" ]]; then
            echo "‚úÖ CPU=$CPU, ANDROID_VERSION=$ANDROID_VERSION"
            echo "CPU=$CPU" >> $GITHUB_ENV
            echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
            # Get short Android version number
            echo "ANDROID_SHORT_VERSION=${ANDROID_VERSION%%.*}" >> $GITHUB_ENV
          else
            echo "‚ùå Unable to extract CPU or Android version from revision"
            exit 1
          fi

          echo "Parse README.md to obtain CPUD and build method..."
          if [[ -s "$README_PATH" ]]; then
            BUILD_LINE=$(grep -m1 'oplus_build_kernel.sh' "$README_PATH" || true)
            if [[ -n "$BUILD_LINE" ]]; then
              CPUD=$(echo "$BUILD_LINE" | awk '{print $(NF-1)}')
              BUILD_METHOD=$(echo "$BUILD_LINE" | awk '{print $NF}')
              echo "‚úÖ CPUD=$CPUD, BUILD_METHOD=$BUILD_METHOD"
              echo "CPUD=$CPUD" >> $GITHUB_ENV
              echo "BUILD_METHOD=$BUILD_METHOD" >> $GITHUB_ENV
            else
              echo "‚ùå The build command was not found in README.md"
            fi
          else
            echo "‚ùå Download failed or is empty for README.md"
          fi
          # Convey combined information
          echo "value=${FILE_BASE}_Android${ANDROID_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Debug Show Selected Inputs
        run: |
          echo "-----------------------"
          echo "Selected CPU: ${{ env.CPU }}"
          echo "Selected CPUD: ${{ env.CPUD }}"
          echo "Selected ANDROID_VERSION: ${{ env.ANDROID_VERSION }}"
          echo "Selected BUILD_METHOD: ${{ env.BUILD_METHOD }}"
          echo "Selected FILE: ${{ github.event.inputs.FILE }}"
          echo "Selected MANAGER_SOURCE: ${{ github.event.inputs.MANAGER_SOURCE }}"
          echo "Selected SUSFS_CI: ${{ github.event.inputs.SUSFS_CI }}"
          echo "Selected KPM: ${{ github.event.inputs.KPM }}"
          echo "Custom SUSFS_META: ${{ github.event.inputs.SUSFS_META }}"
          echo "Custom KSU_META: ${{ github.event.inputs.KSU_META }}"
          echo "Custom BUILD_TIME: ${{ github.event.inputs.BUILD_TIME }}"
          echo -n "BUILD_TIME Unicode: "
          python3 -c "import unicodedata; print(''.join(f'\033[31mU+{ord(c):04X}\033[0m ' if c.isspace() or unicodedata.category(c)=='Cf' else f'U+{ord(c):04X} ' for c in '''${{ github.event.inputs.BUILD_TIME }}'''))"
          echo "Custom SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo -n "SUFFIX Unicode: "
          python3 -c "import unicodedata; print(''.join(f'\033[31mU+{ord(c):04X}\033[0m ' if c.isspace() or unicodedata.category(c)=='Cf' else f'U+{ord(c):04X} ' for c in '''${{ github.event.inputs.SUFFIX }}'''))"
          echo "Selected LSM: ${{ github.event.inputs.LSM }}"
          echo "Selected NETFILTER: ${{ github.event.inputs.NETFILTER }}"
          echo "Selected BBR_ECN: ${{ github.event.inputs.BBR_ECN }}"
          echo "Selected SUSFS_DEV: ${{ github.event.inputs.SUSFS_DEV }}"
          echo "Selected FAST_BUILD: ${{ github.event.inputs.FAST_BUILD }}"
          echo "Selected SCHED: ${{ github.event.inputs.SCHED }}"
          echo "Selected ZRAM: ${{ github.event.inputs.ZRAM }}"
          echo "Selected UNICODE_BYPASS: ${{ github.event.inputs.UNICODE_BYPASS }}"
          echo "Selected XUS_FIX: ${{ github.event.inputs.XUS_FIX }}"
          echo "-----------------------"

      - name: Check Disk Space
        run: df -h

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        if: ${{ github.event.inputs.BUILD_NOCCACHE == 'false' }}
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"
          echo "set: $HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "kingmikhail"
          git config --global user.email "andreimikhail1987@gmail.com"

      - name: Install Dependencies + APTC
        uses: awalsh128/cache-apt-pkgs-action@latest 
        with: 
          packages: python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip gawk dos2unix
          execute_install_scripts: true

      - name: Restore Ccache
        if: ${{ github.event.inputs.BUILD_NOCCACHE == 'false' }}
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.event.inputs.FILE }}-${{ env.BUILD_METHOD }}-${{ github.event.inputs.FAST_BUILD == 'true' && 'alpha' || 'beta' }}-16

      - name: Initialize Ccache
        if: ${{ github.event.inputs.BUILD_NOCCACHE == 'false' }}
        run: |
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              echo "Initialize ccache (${{ env.CCACHE_DIR }})..."
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M ${{ env.CCACHE_MAXSIZE }}
              touch "$INIT_FLAG"
              echo "‚úÖ Ccache initialization complete"
            else
              echo "‚úÖ Ccache has been initialized, skip this step"
            fi
          else
            echo "‚ùå Skip if Ccache is not installed"
          fi
          ccache -s

      - name: Install Repository Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repository and Sync
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          mkdir -p .repo/manifests
          cp "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml" ".repo/manifests/${FILE}.xml"

          MANIFEST_REPO="${{ env.MANIFEST_REPO }}"
          MANIFEST_BRANCH="${{ env.MANIFEST_BRANCH }}"
          CPU="${{ env.CPU }}"
          echo "MANIFEST_REPO=$MANIFEST_REPO"
          echo "MANIFEST_BRANCH=$MANIFEST_BRANCH"

          BASE_URL="https://github.com/${MANIFEST_REPO}/kernel_manifest.git"

          echo "Initialize the repository using the branch $MANIFEST_BRANCH of $MANIFEST_REPO..."
          repo init -u "$BASE_URL" -b "$MANIFEST_BRANCH" -m "${FILE}.xml" --depth=1 --no-clone-bundle --no-tags
          repo sync -c -j$(nproc) --no-clone-bundle --no-tags --force-sync

          for dir in kernel_platform/common kernel_platform/msm-kernel; do
            if [ -e "$dir/BUILD.bazel" ]; then
              sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' "$dir/BUILD.bazel"
            fi
            rm -f "$dir/android/abi_gki_protected_exports_"* 2>/dev/null || echo "No protected exports in $dir"
          done

      - name: Kernel Version Handling
        run: |
          cd kernel_workspace/kernel_platform
          # Get the Android kernel version number (KAndroid version) and the kernel version number (Kernel version)
          for f in ./common/build.config.constants ./common/build.config.common; do
            if [ -f "$f" ]; then
              BRANCH=$(grep -m1 '^BRANCH=' "$f" | cut -d= -f2)
              [ -n "$BRANCH" ] && break
            fi
          done

          if [ -n "$BRANCH" ]; then
            echo "KANDROID_VERSION=${BRANCH%-*}" >> $GITHUB_ENV
            echo "KERNEL_VERSION=${BRANCH#*-}" >> $GITHUB_ENV
          else
            echo "No BRANCH found in build.config files"
          fi

          # Obtain the full kernel version number (Tkernel version) and optional kernel level modification from the Makefile
          ORIG_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          # Force modification of Sublevel (Kernel level)
          SUBLEVEL_INPUT="${{ github.event.inputs.SUBLEVEL }}"
          if [ -n "$SUBLEVEL_INPUT" ]; then
            echo "Change Sublevel to $SUBLEVEL_INPUT"
            sed -i "s/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\1$SUBLEVEL_INPUT/" ./common/Makefile
          else
            echo "Sublevel is not specified; the default value will be retained"
          fi

          # Read the modified version
          NEW_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          if [ "$ORIG_VERSION" != "$NEW_VERSION" ]; then
            echo "Kernel Version:$ORIG_VERSION->$NEW_VERSION"
            echo "TKERNEL_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "Kernel Version:$ORIG_VERSION No changes"
            echo "TKERNEL_VERSION=$ORIG_VERSION" >> $GITHUB_ENV
          fi

          # Kernel version number conversion (For comparison)
          echo "KV1=${BRANCH#*-}"       | cut -d. -f1 >> $GITHUB_ENV
          echo "KV2=${BRANCH#*-}"       | tr -d '.' >> $GITHUB_ENV
          echo "KV3=${NEW_VERSION}"     | tr -d '.' >> $GITHUB_ENV

      # Custom kernel suffix
      - name: Custom Kernel Suffix if set
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          KANDROID_VERSION="${{ env.KANDROID_VERSION }}"
          FAST_BUILD="${{ github.event.inputs.FAST_BUILD }}"

          for path in \
            kernel_platform/common/scripts/setlocalversion \
            kernel_platform/msm-kernel/scripts/setlocalversion \
            kernel_platform/external/dtc/scripts/setlocalversion; do

            [ -f "$path" ] || continue

            echo "Modifying: $path"

            # Remove -dirty
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              echo "Detected NEW setlocalversion format"
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${KANDROID_VERSION}-${SUFFIX}\"|" "$path"

            elif grep -q 'echo "\$res"' "$path"; then
              echo "Detected OLD setlocalversion format"
              if [ "$FAST_BUILD" = "true" ]; then
                echo "FAST_BUILD enabled: using static res"
                sed -i "s/^res=.*/res=\"-${KANDROID_VERSION}-${SUFFIX}\"/" "$path"
              else
                echo "Standard build: injecting suffix via cut/echo"
                if [[ -f ./kernel_platform/build_with_bazel.py ]]; then
                  echo "When compiling using the official script and when using `Build with Bazel`, there may be a limitation on the number of special symbols, If compilation fails, please modify the script"
                  echo "When using the official script and building with build_with_bazel, the build may fail due to a limit on the number of special characters. Please modify the configuration if that happens."
                fi
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
              fi
            else
              echo "Unknown format, appending echo manually"
              echo "echo \"\$res-${SUFFIX}\"" >> "$path"
            fi

            chmod +x "$path"
          done

          git add -A
          git commit -m "Custom suffix & removed -dirty"

      # A random suffix in Pseudo-Official format (Only works if suffix is not set)*
      - name: Custom Kernel Random Suffix if empty
        if: ${{ github.event.inputs.SUFFIX == '' }}
        run: |
          cd kernel_workspace
          KANDROID_VERSION="${{ env.KANDROID_VERSION }}"
          FAST_BUILD="${{ github.event.inputs.FAST_BUILD }}"

          # Generate random numbers and random hashes
          RANDOM_DIGIT=$(od -An -N1 -tu1 < /dev/urandom | tr -d '[:space:]' | awk '{print $1 % 11}')
          RANDOM_HASH=$(od -An -N7 -tx1 /dev/urandom | tr -d ' \n')
          RANDOM_SUFFIX="${RANDOM_DIGIT}-o-g${RANDOM_HASH}"

          for path in \
            kernel_platform/common/scripts/setlocalversion \
            kernel_platform/msm-kernel/scripts/setlocalversion \
            kernel_platform/external/dtc/scripts/setlocalversion; do

            [ -f "$path" ] || continue

            echo "Modifying: $path"

            # Remove -dirty
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              echo "Detected NEW setlocalversion format"
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${KANDROID_VERSION}-${RANDOM_SUFFIX}\"|" "$path"

            elif grep -q 'echo "\$res"' "$path"; then
              echo "Detected OLD setlocalversion format"
              if [ "$FAST_BUILD" = "true" ]; then
                echo "FAST_BUILD enabled: using static res with random suffix"
                sed -i "s/^res=.*/res=\"-${KANDROID_VERSION}-${RANDOM_SUFFIX}\"/" "$path"
              else
                echo "Standard build: injecting random suffix via cut/echo"
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${RANDOM_SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
              fi
            else
              echo "Unknown format, appending echo manually"
              echo "echo \"\$res-${RANDOM_SUFFIX}\"" >> "$path"
            fi

            chmod +x "$path"
          done

          git add -A
          git commit -m "Random suffix & remove -dirty"

      - name: Resolve Manager Source
        id: manager
        run: |
          MANAGER_SOURCE="${{ github.event.inputs.MANAGER_SOURCE }}"

          case "$MANAGER_SOURCE" in
            NEW-SPOOF)
              BRANCH="new-manager"
              ARTIFACT="Spoofed-Manager-release"
              ;;
            NEW)
              BRANCH="new-manager"
              ARTIFACT="Manager-release"
              ;;
            SPOOF)
              BRANCH="main"
              ARTIFACT="Spoofed-Manager-release"
              ;;
            OFFICIAL|*)
              BRANCH="main"
              ARTIFACT="Manager-release"
              ;;
          esac

          echo "manager_branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "manager_artifact=$ARTIFACT" >> "$GITHUB_OUTPUT"

      - name: Add ReSukiSU
        run: |
          cd kernel_workspace/kernel_platform
          MANAGER_BRANCH="${{ steps.manager.outputs.manager_branch }}"
          KSU_META="${{ github.event.inputs.KSU_META }}"

          # It must contain two delimiters (At least three fields)
          if [[ "$(grep -o '/' <<< "$KSU_META" | wc -l)" -lt 2 ]]; then
            echo "Error: The KSU meta parameter is missing the necessary separator '/'.The format should be: branch name/custom identifier(Optional)/Commit hash(Optional)"
            exit 10
          fi

          # Parsing fields: Branch / Custom identifier / Manual hash
          IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$KSU_META"

          echo "Branch name: $BRANCH_NAME"
          [[ -n "$CUSTOM_TAG" ]] && echo "Custom version identification: $CUSTOM_TAG" || echo "Custom version identifier: Not enabled"
          [[ -n "$MANUAL_HASH" ]] && echo "Manually specify hash: $MANUAL_HASH" || echo "Manually specify hash: Not enabled"

          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/new-manager/kernel/setup.sh" | bash -s new-manager
          cd ./KernelSU

          # If a manual hash was specified, switch to this commit
          if [[ -n "$MANUAL_HASH" ]]; then
            git fetch origin "$BRANCH_NAME" --depth=50
            git checkout "$MANUAL_HASH"
            SHORT_HASH=${MANUAL_HASH:0:8}
          fi

          KSU_API_VERSION=$(curl -fsSL "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/new-manager/kernel/Kbuild" | \
            grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
          if [[ -z "$KSU_API_VERSION" || "$(printf '%s\n' "$KSU_API_VERSION" "3.1.7" | sort -V | head -n1)" != "3.1.7" ]]; then
            KSU_API_VERSION="3.1.7"
          fi
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> $GITHUB_ENV

          GIT_HASH=$(git rev-parse --short HEAD)
          echo "GIT_HASH=$GIT_HASH"

          # Assembly version number
          if [[ -n "$MANUAL_HASH" ]]; then
            USE_HASH="$SHORT_HASH"
          else
            USE_HASH="$GIT_HASH"
          fi
          if [[ -z "$CUSTOM_TAG" ]]; then
            VERSION_FULL="v$KSU_API_VERSION-$USE_HASH@$BRANCH_NAME"
          else
            VERSION_FULL="$KSU_API_VERSION-$CUSTOM_TAG"
          fi

          # Clean up and write Kbuild version information
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild
          sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild

          VERSION_DEFINITIONS=$(cat <<EOF
            define get_ksu_version_full
            $VERSION_FULL
            endef

            KSU_VERSION_API := $KSU_API_VERSION
            KSU_VERSION_FULL := $VERSION_FULL
          EOF
          )

          awk -v def="$VERSION_DEFINITIONS" '
            /REPO_OWNER :=/ {print; print def; inserted=1; next}
            1
            END {if (!inserted) print def}
          ' kernel/Kbuild > kernel/Kbuild.tmp && mv kernel/Kbuild.tmp kernel/Kbuild

          KSU_VERSION=$(expr $(git rev-list --count "$MANAGER_BRANCH" 2>/dev/null || echo 13000) + 30700)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

          echo "::group::Final Kbuild version information and partial debug results preview"
          grep -A10 "REPO_OWNER" kernel/Kbuild
          grep "KSU_VERSION_FULL" kernel/Kbuild
          echo "::endgroup::"

      - name: Apply Patches ReSukiSU
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          cd kernel_workspace
          if [ "${{ github.event.inputs.SUSFS_META }}" != "-1" ]; then
            SUSFS_META="${{ github.event.inputs.SUSFS_META }}"
            git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}${{ github.inputs.SUSFS_DEV == 'true' && '-dev' || '' }}
            cd susfs4ksu
            [ -n "$SUSFS_META" ] && git checkout "$SUSFS_META" || echo "If SUSFS meta is empty, use the latest upstream SUSFS"
            cd ..
          fi
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/kingmikhail/KingMikhail-Xclusive.git
          cd kernel_platform
          if [ "${{ github.event.inputs.SUSFS_META }}" != "-1" ]; then
            echo "Pulling SUSFS patch"
            cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          fi

          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "Pulling ZRAM patch"
            cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux/
            cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib/
            cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto/
            cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          fi

          cd ./common
          GKI_V="${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}"
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ')

          if [ "$GKI_V" == "android13-5.15" ] && [ "$SUBLEVEL" -lt 123 ]; then
            echo "Fixed some bugs caused by kernel versions 5.15.0~5.15.123 only supporting older versions of the C library"
            cp ../../KingMikhail-Xclusive/Patches/5.15-Legacy ./5.15-Legacy.patch
            patch -p1 < 5.15-Legacy.patch
            echo "fix 5.15 patch complete"
          fi

          if [[ "${{ env.KV2 }}" == "66" && "${{ env.KV3 }}" -le 6630 && "${{ github.event.inputs.SUSFS_META }}" != "-1" ]]; then
            TRUSTY_EXISTS="false"
            if grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml"; then
              TRUSTY_EXISTS="true"
            fi
            echo "trusty_exists=$TRUSTY_EXISTS" >> $GITHUB_OUTPUT
            if [[ "$TRUSTY_EXISTS" == "false" ]]; then
              echo "Fixed a susfs error caused by the absence of Trusty in the source code and inventory for models with kernel versions 6.6.0~6.6.30"
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' 50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch
              sed -i '/#include <trace\/hooks\/fs.h>/d' 50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch
            fi
          fi

          if [ "${{ github.event.inputs.SUSFS_META }}" != "-1" ]; then
            # Fake Patch to fix failures
            fake_patched=0
            if [ "$GKI_V" = "android15-6.6" ]; then
              if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                echo "NR subpages not found, patching is underway"
                sed -i -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' ./fs/proc/task_mmu.c
                fake_patched=1
              fi
            fi
            if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ] || [ "$GKI_V" = "android14-6.1" ]; then
              if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
                echo "VMA pages not found, patching is underway"
                fake_patched=1
              fi
            fi

            echo "Applying SUSFS patch"
            patch -p1 < 50_add_susfs_in_gki-${{ env.KANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
            echo "SUSFS patch complete"

            # Revert
            if [ "$fake_patched" = 1 ]; then
              if [ "$GKI_V" = "android15-6.6" ]; then
                if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                  sed -i -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' -e '/pagemap_entry_t \*res = NULL;/d' ./fs/proc/task_mmu.c
                fi
              fi
              if [ "$GKI_V" = "android12-5.10" ] || [ "$GKI_V" = "android13-5.15" ] || [ "$GKI_V" = "android14-6.1" ]; then
                if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                  sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
                fi
              fi
            fi
            if [ "${{ github.event.inputs.SUSFS_META }}" != "-1" ] && [ "${{ github.event.inputs.XUS_FIX }}" = "true" ]; then
              cp ../../KingMikhail-Xclusive/Patches/XUS ./
              patch -p1 < XUS || true
            fi
          fi

      # OGKI to GKI conversion, no dtbo boot modification required
      - name: Apply Convert HMBIRD_OGKI to HMBIRD_GKI
        if: ${{ fromJSON(env.KV1) >= 6 && fromJSON(env.KV2) >= 66 && github.event.inputs.SCHED == 'false' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/KingMikhail-Xclusive/Patches"
          cd kernel_workspace/kernel_platform/common
          for p in ./kernel/sched/hmbird* ./vendor/oplus/kernel/cpu/sched_ext/hmbird*; do
            [ -d "$p" ] && {
              echo "The code for Fengchi already exists in the source code; enable secondary rollback"
              exit 0
            }
          done
          sed -i '1iobj-y += HMBIRD.o' drivers/Makefile
          echo "Applying OGKI to GKI conversion patch"
          patch -p1 -F 3 < "${PATCH_DIR}/HMBIRD" || true
          echo "OGKI to GKI patch conversion complete"

      - name: Apply Unicode Bypass
        if: ${{ github.event.inputs.UNICODE_BYPASS == 'true' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/KingMikhail-Xclusive/Patches"
          cd kernel_workspace/kernel_platform/common
          if [ "$KV1" -lt 6 ]; then
            patch -p1 --forward < "${PATCH_DIR}/Unicode-6.1-M" || true
          else
            patch -p1 --forward < "${PATCH_DIR}/Unicode-6.1-P" || true
          fi

      - name: Apply ZRAM
        if: ${{ github.event.inputs.ZRAM == 'true' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}"
          cd kernel_workspace/kernel_platform/common
          echo "Currently applying the LZ4KD patch"
          patch -p1 -F 3 < "${PATCH_DIR}/lz4kd.patch" || true
          echo 'LZ4KD patch complete'
          echo "Patch LZ4K OnePlus is being applied"
          patch -p1 -F 3 < "${PATCH_DIR}/lz4k_oplus.patch" || true
          echo 'LZ4K OnePlus complete'

      - name: APPLYING FENGCHI KERNEL
        env:
          FILE: ${{ github.event.inputs.FILE }}
        if: ${{ github.event.inputs.SCHED == 'true' }}
        run: |
          cd kernel_workspace/kernel_platform/common
          for p in ./kernel/sched/hmbird* ./vendor/oplus/kernel/cpu/sched_ext/hmbird*; do
            [ -d "$p" ] && {
              echo "The Code for Fengchi Already Exists in the Source Code, Enabling Secondary Rollback"
              exit 0
            }
          done          
          git clone https://github.com/kingmikhail/KingMikhail-Xclusive.git -b $CPU || { echo "CPU Branch Doesn't Exist, Fengchi Kernel Doesn't Currently Support Device Model, Please Close and Try Again"; exit 11; }
          echo "Pulling the Fengchi Windspeed Patch"
          cp ./KingMikhail-Xclusive/fengchi_${FILE}.patch ./
          if [[ -f "fengchi_${FILE}.patch" ]]; then
            echo "Applying the Fengchi Windspeed Patch"
            dos2unix "fengchi_${FILE}.patch"
            patch -p1 -F 3 < "fengchi_${FILE}.patch"
            echo "Fengchi Windspeed Patch Complete"
          else
            echo "‚úñÔ∏è No Patch Found, Fengchi Kernel Doesn't Currently Support Device Model, Close And Try Again"
            exit 12
          fi

      - name: Apply LSM BBG
        if: ${{ github.event.inputs.LSM == 'true' }}
        run: |
          cd kernel_workspace/kernel_platform/common
          echo "Enabling Kernel-level baseband protection support..."
          curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | bash -s fix_blkdev_rename
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' ./security/Kconfig

      # Configuration information, marked with * indicates additional items, which carry a certain degree of risk and uncertainty
      - name: Add Configuration Settings
        run: |
          cd kernel_workspace/kernel_platform/common
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig
          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"

          # ReSukiSU Config
          echo "CONFIG_KSU=y" >> "$CONFIG_FILE"

          # KPM Config
          if [ "${{ github.event.inputs.KPM }}" = "KPM" ] || [ "${{ github.event.inputs.KPM }}" = "NoN" ]; then
            echo "CONFIG_KPM=y" >> "$CONFIG_FILE"
          fi
          if [ "${{ github.event.inputs.KPM }}" = "KPN" ]; then
            echo "CONFIG_KPM=n" >> "$CONFIG_FILE"
          fi

          # SUSFS Config
          if [ "${{ github.event.inputs.SUSFS_META }}" != "-1" ]; then
            echo "CONFIG_KSU_SUSFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$CONFIG_FILE"
          else
            echo "CONFIG_KSU_SUSFS=n" >> "$CONFIG_FILE"
          fi

          # TMPFS Config*
          echo "CONFIG_TMPFS_XATTR=y" >> "$CONFIG_FILE"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$CONFIG_FILE"

          # BBR & ECN Config*
          if [ "${{ github.event.inputs.BBR_ECN }}" = "true" ]; then
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> "$CONFIG_FILE"
            echo "CONFIG_TCP_CONG_BBR=y" >> "$CONFIG_FILE"
            echo "CONFIG_NET_SCH_FQ=y" >> "$CONFIG_FILE"
            echo "CONFIG_TCP_CONG_BIC=n" >> "$CONFIG_FILE"
            echo "CONFIG_TCP_CONG_WESTWOOD=n" >> "$CONFIG_FILE"
            echo "CONFIG_TCP_CONG_HTCP=n" >> "$CONFIG_FILE"
            echo "CONFIG_IP_ECN=y" >> "$CONFIG_FILE"
            echo "CONFIG_TCP_ECN=y" >> "$CONFIG_FILE"
            echo "CONFIG_IPV6_ECN=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_NF_TARGET_ECN=y" >> "$CONFIG_FILE"
          fi

          # ZRAM Config*
          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "CONFIG_CRYPTO_LZ4HC=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4K=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4KD=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_842=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> "$CONFIG_FILE"
            echo "CONFIG_ZRAM_WRITEBACK=y" >> "$CONFIG_FILE"
          fi

          # LSM Config*
          if [ "${{ github.event.inputs.LSM }}" = "true" ]; then
            echo "CONFIG_BBG=y" >> "$CONFIG_FILE"
          fi

          # IPSET & IPV6 NAT Config*
          if [[ "${CPU}" == sm* && "${{ github.event.inputs.NETFILTER }}" == "true" ]]; then
            echo "CONFIG_BPF_STREAM_PARSER=y" >> "$CONFIG_FILE"
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> "$CONFIG_FILE"
            echo "CONFIG_NETFILTER_XT_SET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_MAX=65534" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IP=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_MAC=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_NET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP_SET_LIST_SET=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP6_NF_NAT=y" >> "$CONFIG_FILE"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> "$CONFIG_FILE"
          fi

          # Fix build issues
          if [ "$KERNEL_VERSION" = "6.1" ] && [[ "$CPU" == mt* ]]; then
            echo "CONFIG_DEBUG_INFO_BTF=n" >> "$CONFIG_FILE"
          fi

          # Remove build review
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Fix IPV6 Nat Error
        if: ${{ github.event.inputs.NETFILTER == 'true' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/KingMikhail-Xclusive/Patches"
          cd kernel_workspace/kernel_platform/common
          if [[ "${CPU}" == sm* ]]; then
            echo "Fix potential false alarms from devices after enabling IPV6 NAT..."
            patch -p1 -F 3 < "${PATCH_DIR}/IPV6"
          else
            echo "Your device does not support IPV6 NAT, skip this step"
          fi

      # Custom kernel build time, without adding #1 SMP PREEMPT
      - name: Custom Build Time
        shell: bash
        run: |
          INPUT_TIME="${{ github.event.inputs.BUILD_TIME }}"
          if [[ -n "$INPUT_TIME" && "$INPUT_TIME" != "F" && "$INPUT_TIME" != "f" ]]; then
            DATESTR="$INPUT_TIME"
            echo "Using input BUILD_TIME: $DATESTR"
          else
            DATESTR="$(TZ='UTC' date +'%a %b %d %T %Z %Y')"
            echo "Using UTC time as fallback: $DATESTR"
          fi
          echo "KBUILD_BUILD_TIMESTAMP=${DATESTR}" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_VERSION=1" >> "$GITHUB_ENV"
          cd kernel_workspace/kernel_platform/
          for f in common/scripts/mkcompile_h msm-kernel/scripts/mkcompile_h; do
            if [ -f "$f" ]; then
              echo "Patching mkcompile_h with BUILD_TIME=$DATESTR"
              if grep -q 'UTS_VERSION=' "$f"; then
                perl -pi -e "s{UTS_VERSION=\"\\\$\\(.*?\\)\"}{UTS_VERSION=\"#1 SMP PREEMPT $DATESTR\"}" "$f"
              else
                perl -0777 -pi -e "s{cat <<EOF}{cat <<EOF\n#undef UTS_VERSION\n#define UTS_VERSION \"#1 SMP PREEMPT $DATESTR\" } unless /UTS_VERSION/" "$f"
              fi
            fi
          done

      - name: Enable LTO=Thin For Fast
        if: ${{ (env.KERNEL_VERSION == '5.10' || env.KERNEL_VERSION == '5.15') && github.event.inputs.FAST_BUILD == 'true' }}
        run: |
          cd kernel_workspace/kernel_platform
          DEFCONFIG=./common/arch/arm64/configs/gki_defconfig
          echo "Enabling ThinLTO in $DEFCONFIG"
          sed -i 's/^CONFIG_LTO=n/CONFIG_LTO=y/' "$DEFCONFIG"
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG"
          sed -i 's/^CONFIG_LTO_CLANG_NONE=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG"
          grep -q '^CONFIG_LTO_CLANG_THIN=y' "$DEFCONFIG" || echo 'CONFIG_LTO_CLANG_THIN=y' >> "$DEFCONFIG"

      - name: Disable GPUEB
        if: ${{ env.KERNEL_VERSION == '5.10' && startsWith(env.CPU, 'mt') }}
        run: |
          echo "Disabling GPUEB for MTK kernel 5.10"
          sed -i '/obj-y.*gpueb/d' kernel_workspace/kernel-5.10/drivers/gpu/mediatek/Makefile

      - name: Build Kernel FAST
        if: ${{ github.event.inputs.FAST_BUILD == 'true' }}
        id: fast_build
        run: |
          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"
          cd kernel_workspace/kernel_platform

          # LLVM IAS
          if [[ -f ./common/build.config.arm ]] && grep -q '^LLVM_IAS=1' ./common/build.config.arm; then
            USE_LLVM_IAS=true
          else
            USE_LLVM_IAS=false
          fi

          # Read Clang prebuilt bin from build.config.common
          CLANG_PREBUILT_BIN=$(grep '^CLANG_PREBUILT_BIN=' ./common/build.config.common | cut -d'=' -f2 || true)
          if [[ -z "$CLANG_PREBUILT_BIN" ]]; then
            echo "‚ö†Ô∏è Clang prebuilt bin was not found in build.config.common. Revert to the official build script"
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            echo "Please consider disabling fast build and submit an issue"
            exit 0
          fi

          # Try extracting the Clang-r version from Clang prebuilt bin first
          if [[ "$CLANG_PREBUILT_BIN" =~ (clang-r[0-9a-z]+) ]]; then
            CLANG_VERSION="${BASH_REMATCH[1]}"
          else
            # If no match is found, try extracting from build.config.constants
            if [[ -f ./common/build.config.constants ]]; then
              CLANG_VERSION=$(grep '^CLANG_VERSION=' ./common/build.config.constants | cut -d'=' -f2 || true)
            fi
          fi

          if [[ -z "$CLANG_VERSION" ]]; then
            echo "‚ö†Ô∏è Unable to obtain the Clang version from Clang prebuilt bin or build.config.constants; reverting to the official build script"
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            echo "Please consider disabling fast build and submit an issue"
            exit 0
          fi

          # Replace with the new Clang version value
          CLANG_PREBUILT_BIN=${CLANG_PREBUILT_BIN/\$\{CLANG_VERSION\}/$CLANG_VERSION}
          # Get the first directory name of Clang prebuilt bin and assign it to Clang dir
          CLANG_DIR=$(echo "$CLANG_PREBUILT_BIN" | cut -d'/' -f1)
          # Get the parent directory name of Clang prebuilt bin and assign it to Clang path
          CLANG_PATH=$(basename "$(dirname "$CLANG_PREBUILT_BIN")")

          echo "‚úÖ CLANG_VERSION=$CLANG_VERSION"
          echo "‚úÖ CLANG_DIR=$CLANG_DIR"
          echo "‚úÖ CLANG_PATH=$CLANG_PATH"
          echo "‚úÖ USE_LLVM_IAS=$USE_LLVM_IAS"

          export PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/$CLANG_PREBUILT_BIN:$PATH"
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"
          sudo apt install -y libelf-dev ccache

          cd ./common
          MAKE_ARGS="LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc \
            PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole \
            LD=ld.lld HOSTLD=ld.lld KCFLAGS+=-Wno-error"

          if [[ "$USE_LLVM_IAS" == "true" ]]; then
            MAKE_ARGS="LLVM_IAS=1 $MAKE_ARGS"
          fi

          make -j$(nproc --all) O=out $MAKE_ARGS gki_defconfig
          make -j$(nproc --all) O=out $MAKE_ARGS
          ccache -s

      - name: Fallback To Build Kernel
        if: ${{ github.event.inputs.FAST_BUILD == 'false' || steps.fast_build.outputs.fallback == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f ./kernel_platform/build_with_bazel.py ]; then
            ./kernel_platform/oplus/bazel/oplus_modules_variant.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
            ./kernel_platform/build_with_bazel.py -t ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
          else
            LTO=thin SYSTEM_DLKM_RE_SIGN=0 BUILD_SYSTEM_DLKM=0 KMI_SYMBOL_LIST_STRICT_MODE=0 \
            ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
          fi

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/kingmikhail/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/kernel_platform/out/Final-Image-Find/
          image_path=$(find "./kernel_workspace/kernel_platform/common/out/" -name "Image" | head -n 1)
          if [ -n "$image_path" ]; then
            echo "The unified path used by make for compilation successfully located the Image file"
          else
            image_path=$(find "./kernel_workspace/kernel_platform/out/" -name "Image" | head -n 1)
            if [ -n "$image_path" ]; then
              echo "The image file was successfully found after compiling using the official script"
            else
              echo "Image file not found, build failed" >&2
              exit 1
            fi
          fi
          if [ -n "$image_path" ] && [ -f "$image_path" ]; then
            echo "Image file finally located at: $image_path"
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/kernel_platform/out/Final-Image-Find/Image
          fi

      - name: Apply Patch Linux and Replace Image
        if: ${{ github.event.inputs.KPM == 'KPM' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/SukiSU_patch/kpm"
          OUT_DIR="${GITHUB_WORKSPACE}/kernel_workspace/kernel_platform/out/Final-Image-Find"
          cd "${OUT_DIR}"
          cp "${PATCH_DIR}/Workplace" .
          chmod +x Workplace
          ./Workplace
          rm -f Image
          mv oImage Image
          cp Image "${GITHUB_WORKSPACE}/AnyKernel3/Image"

      - name: Download Latest SUSFS Module From CI
        if: ${{ github.event.inputs.SUSFS_CI == 'CI' && github.event.inputs.SUSFS_META != '-1' }}
        continue-on-error: true
        run: |
          LATEST_RUN_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs?status=success" | \
            jq -r '.workflow_runs[] | select(.head_branch == "v1.5.2+") | .id' | head -n 1)
          if [ -z "$LATEST_RUN_ID" ]; then
            echo "No successful run found for branch v1.5.2+"
          else
            ARTIFACT_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$LATEST_RUN_ID/artifacts" | jq -r '.artifacts[0].archive_download_url')
            if [ -n "$ARTIFACT_URL" ]; then
              curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -o ksu_module_susfs_1.5.2+_CI.zip "$ARTIFACT_URL"
              cp ksu_module_susfs_1.5.2+_CI.zip ./AnyKernel3/
            else
              echo "Failed to fetch artifact URL"
            fi
          fi

      - name: Download Latest SUSFS Module From Release
        if: ${{ github.event.inputs.SUSFS_CI == 'Release' && github.event.inputs.SUSFS_META != '-1' }}
        continue-on-error: true
        run: |
          wget -O ksu_module_susfs_1.5.2+_Release.zip https://github.com/sidex15/ksu_module_susfs/releases/latest/download/ksu_module_susfs_1.5.2+.zip
          cp ksu_module_susfs_1.5.2+_Release.zip ./AnyKernel3/

      - name: Download Latest ReSukiSU APK From CI
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MANAGER_BRANCH="${{ steps.manager.outputs.manager_branch }}"
          MANAGER_ARTIFACT="${{ steps.manager.outputs.manager_artifact }}"

          echo "Using branch: $MANAGER_BRANCH"
          echo "Downloading artifact: $MANAGER_ARTIFACT"

          run_id=$(gh api "repos/ReSukiSU/ReSukiSU/actions/workflows/build-manager.yml/runs?branch=new-manager&status=success&per_page=1" --jq '.workflow_runs[0].id' || echo "")

          if [[ -z "$run_id" ]]; then
            echo "No successful workflow run found on branch $MANAGER_BRANCH. Skipping download."
            exit 0
          fi
          artifact_url=$(gh api "repos/ReSukiSU/ReSukiSU/actions/runs/$run_id/artifacts" | jq -r ".artifacts[] | select(.name == \"$MANAGER_ARTIFACT\") | .archive_download_url" | head -n1)

          if [[ -z "$artifact_url" ]]; then
            echo "No artifact '$MANAGER_ARTIFACT' found in run $run_id. Skipping download."
            exit 0
          fi
          echo "Downloading from: $artifact_url"
          curl -fL -H "Authorization: token $GITHUB_TOKEN" -o "${MANAGER_ARTIFACT}.zip" "$artifact_url"
          unzip -j "${MANAGER_ARTIFACT}.zip" "*.apk" -d ./AnyKernel3/

      - name: Set Zip Suffix
        id: suffix
        run: |
          echo "value=${{ github.event.inputs.ZRAM == 'true' && '_LZ4KD' || '' }}${{ github.event.inputs.KPM == 'KPM' && '_KPM' || github.event.inputs.KPM == 'KPN' && '_KPN' || '' }}${{ github.event.inputs.LSM == 'true' && '_LSM' || '' }}_ILH${{ github.event.inputs.SCHED== 'true' && '_SCHED' || '' }}" >> $GITHUB_OUTPUT

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: AK3-ReSukiSU-${{ env.KSUVER }}
          path: ./AnyKernel3/*

      - name: Download And Unzip ZRAM
        if: ${{ github.event.inputs.ZRAM == 'true' }}
        id: zram_find
        run: |
          set -e
          sudo apt install -y unzip
          echo "Â∞ùËØïËé∑Âèñ ZRAM Ê®°Âùó zip ‰∏ãËΩΩÈìæÊé•..."
          retries=3
          success=0
          for i in $(seq 1 $retries); do
            echo "Á¨¨ $i Ê¨°Â∞ùËØï‰∏ãËΩΩ..."
            download_url=$(curl -s https://api.github.com/repos/FurLC/ZRAM-Module/releases/latest | \
              grep "browser_download_url" | grep "ZRAM-Module-.*\.zip" | cut -d '"' -f 4 | head -n 1)

            if [ -n "$download_url" ]; then
              echo "‚úÖ Download link successfully obtained: $download_url"
              wget -N "$download_url" && success=1 && break
            else
              echo "‚ö†Ô∏è Failed to retrieve download link, please try again in 3 seconds..."
              sleep 3
            fi
          done

          if [ "$success" -ne 1 ]; then
            echo "‚ùå Unable to obtain the ZRAM module download link after $retries of consecutive attempts"
            echo "upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          unzip "$(ls -t ZRAM-Module-*.zip | head -1)" -d ZRAM-Module
          target="./ZRAM-Module/zram/zram.ko"
          echo "Find the ZRAM.ko module file..."
          search_paths=(
            "./kernel_workspace/kernel_platform/out"
            "./kernel_workspace/device/qcom"
          )
          zram_path=""
          for path in "${search_paths[@]}"; do
            zram_path=$(find "$path" -type f -name "zram.ko" | head -n 1)
            [ -n "$zram_path" ] && break
          done
          if [ -z "$zram_path" ]; then
            zram_path=$(find "./kernel_workspace" -type f -name "zram.ko" | head -n 1)
          fi
          if [ -n "$zram_path" ] && [ -f "$zram_path" ]; then
            echo "ZRAM module file finally located at: $zram_path"
            mkdir -p "$(dirname "$target")"
            if [ "$(realpath "$zram_path")" != "$(realpath "$target")" ]; then
              cp "$zram_path" "$target"
            else
              echo "If the source file and target path are the same, skip copying"
            fi
          else
            echo "The ZRAM.ko file was not found, possibly due to an unsupported kernel version or an unsuccessful build"
            echo "upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Upload ZRAM Module
        if: ${{ github.event.inputs.ZRAM == 'true' && steps.zram_find.outputs.upload != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: ZRAM-Module_${{ env.KERNEL_VERSION }}_${{ steps.extract_info.outputs.value }}
          path: ZRAM-Module/*

      - name: Post-build Disk Check
        run: df -h
